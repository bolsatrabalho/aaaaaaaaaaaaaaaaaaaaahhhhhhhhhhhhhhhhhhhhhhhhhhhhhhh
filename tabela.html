<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
    }
    input {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin: 5px;
      padding: 8px 12px;
    }
  </style>
</head>

<body onload="carregarDados()">

  <h2>Controle de Frequência - Bolsistas</h2>

  <button onclick="adicionarLinha()">Adicionar bolsista</button>
  <button onclick="salvar()">Salvar</button>
  <button onclick="enviarPlanilha()">Enviar planilha</button>

  <table id="tabela">
    <thead>
      <tr>
        <th>Matrícula</th>
        <th>Setor</th>
        <th>Email do coordenador</th>
        <th>Vigência início</th>
        <th>Vigência fim</th>
        <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th>
        <th>Mai</th><th>Jun</th><th>Jul</th><th>Ago</th>
        <th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
        <th>Justificativa</th>
        <th>Arquivo</th>
        <th>Última atualização</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
let dadosGlobais = [];

function carregarDados() {
  google.script.run.withSuccessHandler(dados => {
    dadosGlobais = dados || [];
    montarTabela();
  }).buscarDados();
}

function montarTabela() {
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";

  dadosGlobais.forEach(linha => {
    const tr = document.createElement("tr");

    linha.forEach(valor => {
      const td = document.createElement("td");
      const input = document.createElement("input");
      input.value = valor ?? "";
      td.appendChild(input);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

function adicionarLinha() {
  const colunas = document.querySelectorAll("#tabela thead th").length;
  const novaLinha = Array(colunas).fill("");
  dadosGlobais.push(novaLinha);
  montarTabela();
}

function salvar() {
  const tbody = document.querySelector("#tabela tbody");
  const linhas = [...tbody.rows].map(tr =>
    [...tr.cells].map(td => td.querySelector("input").value)
  );

  google.script.run.salvarDados(linhas);
  alert("Dados salvos com sucesso!");
}

function enviarPlanilha() {
  google.script.run.enviarPlanilha();
  alert("Planilha enviada!");
}
</script>

</body>
</html>
